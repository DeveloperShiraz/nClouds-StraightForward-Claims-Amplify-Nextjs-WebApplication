version: 1
applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            - export NODE_OPTIONS="--max-old-space-size=12288"
            - npm install -g pnpm
            - pnpm install --force
        build:
          commands:
            - pnpm run build
            # Delete development-only directories from .next
            - rm -rf .next/cache .next/dev .next/diagnostics .next/turbopack .next/standalone
            - rm -f .next/trace .next/trace-build
            # Delete build-only packages from node_modules (not needed for SSR runtime)
            # Use find to properly clean pnpm's content-addressable store
            - find node_modules -maxdepth 1 -name "aws-cdk-lib" -o -name "aws-cdk" -o -name "@aws-cdk" -o -name "constructs" -o -name "typescript" -o -name "esbuild" -o -name "@esbuild" -o -name "@swc" -o -name "@parcel" -o -name "tsx" | xargs rm -rf
            - find node_modules/.pnpm -maxdepth 1 -type d \( -name "aws-cdk-lib@*" -o -name "aws-cdk@*" -o -name "@aws-cdk+*" -o -name "constructs@*" -o -name "typescript@*" -o -name "esbuild@*" -o -name "@esbuild+*" -o -name "@swc+*" -o -name "@parcel+*" -o -name "tsx@*" -o -name "core-js@*" -o -name "sharp@*" \) -exec rm -rf {} + 2>/dev/null || true
            # Remove unnecessary files from remaining node_modules
            - find node_modules -name "*.md" -not -name "LICENSE*" -delete 2>/dev/null || true
            - find node_modules -name "CHANGELOG*" -delete 2>/dev/null || true
            - find node_modules -name "*.map" -delete 2>/dev/null || true
            - find node_modules -name "*.d.ts" -delete 2>/dev/null || true
            - find node_modules -type d -name "__tests__" -exec rm -rf {} + 2>/dev/null || true
            - find node_modules -type d -name "test" -exec rm -rf {} + 2>/dev/null || true
            - find node_modules -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
            - find node_modules -type d -name "docs" -exec rm -rf {} + 2>/dev/null || true
            # Show size of build output for debugging
            - du -sh .next
            - du -sh node_modules 2>/dev/null || true
      artifacts:
        baseDirectory: .next
        files:
          - "**/*"
      cache:
        paths:
          - .pnpm-store/**/*
    backend:
      phases:
        preBuild:
          commands:
            - export NODE_OPTIONS="--max-old-space-size=12288"
            - export AMPLIFY_CLI_MEMORY_LIMIT=12288
            - export AMPLIFY_CDK_MEMORY_LIMIT=12288
            - npm install -g pnpm
            # Install specific version of esbuild globally
            - npm install -g esbuild@0.25.2
            - rm -rf node_modules
            - rm -rf .pnpm-store
            - pnpm install --force
            # Install same version locally
            - pnpm add -D esbuild@0.25.2
            # Remove any other versions
            - rm -rf node_modules/.pnpm/esbuild@0.23.1
        build:
          commands:
            - export NODE_OPTIONS="--max-old-space-size=12288"
            - export ESBUILD_BINARY_PATH=$(which esbuild)
            - pnpm exec ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
