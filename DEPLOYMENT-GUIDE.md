# Deployment Guide

## Environment Variables Setup

### For Amplify Console (Production)

In the AWS Amplify Console → Your App → Environment variables, add:

1. **NEXT_PUBLIC_AWS_REGION** = `us-east-1`
   - This is required for the client-side and server-side AWS SDK calls
   - Amplify accepts environment variables with `NEXT_PUBLIC_` prefix

2. **AMPLIFY_AUTH_USERPOOL_ID** (Optional for production)
   - In production, this will be auto-generated by Amplify from `amplify_outputs.json`
   - Only needed if you want to override the auto-generated value

### For Local Development

Your `.env` file should contain:

```env
# AWS Region
NEXT_PUBLIC_AWS_REGION=us-east-1

# Cognito User Pool (auto-generated by Amplify sandbox)
AMPLIFY_AUTH_USERPOOL_ID=us-east-1_tZNDRv3SH

# AWS Credentials (only for local development)
AWS_ACCESS_KEY_ID=your-access-key-id
AWS_SECRET_ACCESS_KEY=your-secret-access-key

# CDK Bootstrap
CDK_NEW_BOOTSTRAP="1"
```

## How It Works

### AWS Configuration Helper (`lib/aws-config.ts`)

All API routes now use a centralized AWS configuration helper that:

1. **Local Development**: Uses environment variables (`AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`)
2. **Production (Amplify)**: Automatically uses IAM roles assigned to the Lambda functions (no credentials needed)

### API Routes

All API routes have been updated to use:
- `getDynamoDBClientConfig()` - for DynamoDB operations
- `getCognitoClientConfig()` - for Cognito operations
- `getS3ClientConfig()` - for S3 operations
- `getUserPoolId()` - to get the User Pool ID

## Deployment Steps

### 1. Before Pushing to Git

- ✅ Ensure `.env` is in `.gitignore` (already done)
- ✅ Update `.env.example` with the new format (already done)
- ✅ Build succeeds locally: `pnpm run build`

### 2. Configure Amplify Console

1. Go to AWS Amplify Console
2. Select your app
3. Go to "Environment variables"
4. Add: `NEXT_PUBLIC_AWS_REGION` = `us-east-1`

### 3. Push to Git

```bash
git add .
git commit -m "feat: Multi-tenant system with company selection for SuperAdmin

- Add company dropdown for SuperAdmin in incident report form
- Fix claim number not showing in reports page
- Fix user counts showing global numbers instead of company-specific
- Add public form access for IncidentReporters
- Update AWS configuration to work in both local and production
- Use centralized aws-config helper for all AWS SDK calls"

git push origin main
```

### 4. Monitor Deployment

1. Watch the Amplify Console build logs
2. Wait for deployment to complete
3. Verify the production URL works

### 5. Post-Deployment Tasks

#### A. Add Custom Cognito Attributes

The production User Pool needs custom attributes for company information:

```bash
aws cognito-idp add-custom-attributes \
  --user-pool-id <PRODUCTION_USER_POOL_ID> \
  --custom-attributes Name=companyId,AttributeDataType=String,Mutable=true Name=companyName,AttributeDataType=String,Mutable=true \
  --region us-east-1
```

#### B. Create Initial SuperAdmin User

1. Go to Cognito Console → Production User Pool
2. Create a SuperAdmin user
3. Assign to SuperAdmin group

#### C. Create Companies

1. Log in as SuperAdmin
2. Go to Companies page
3. Create your companies

#### D. Update DynamoDB Table Names

After deployment, you'll need to update the hardcoded table names in API routes:

1. Get the production table names from `amplify_outputs.json`
2. Update these files:
   - `app/api/incident-reports/route.ts`
   - `app/api/incident-reports/[id]/route.ts`
   - `app/api/admin/companies/route.ts`
   - `app/api/admin/companies/[id]/route.ts`
   - `app/api/public/incident-reports/route.ts`
   - `app/api/upload/photos/route.ts` (S3 bucket name)

**Better Solution**: Convert to use Amplify Data Client instead of direct DynamoDB calls (recommended for future iteration)

### 6. Cleanup Old Resources

After successful deployment, delete old manual resources to avoid AWS charges:

#### Old S3 Bucket
```bash
# List contents first
aws s3 ls s3://<old-bucket-name>/ --recursive

# If you want to keep data, download first
aws s3 sync s3://<old-bucket-name>/ ./backup/

# Delete bucket
aws s3 rm s3://<old-bucket-name>/ --recursive
aws s3 rb s3://<old-bucket-name>
```

#### Old Cognito User Pool
- User Pool ID: `us-east-1_XsGcRjOxp`
- Delete via AWS Console → Cognito → Delete User Pool

#### Old DynamoDB Tables
- `Company-manual`
- `IncidentReport-manual`
- Delete via AWS Console → DynamoDB → Delete Table

## Troubleshooting

### Build Fails with "Cannot find module"

If scripts have missing dependencies, they're now excluded from the build via `tsconfig.json`.

### "Credentials not configured" Error

In production, this means:
- IAM roles are not attached to Lambda functions (Amplify should handle this automatically)
- Check Amplify service role has necessary permissions

In local development:
- Check `.env` file has `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY`

### Table Names Don't Match

Production table names are different from sandbox. You need to:
1. Check `amplify_outputs.json` for production table names
2. Update hardcoded table names in API routes
3. Or better: migrate to Amplify Data Client

## Next Steps (Recommended)

1. **Migrate to Amplify Data Client**: Replace direct DynamoDB calls with Amplify Data Client to automatically handle table names
2. **Add Environment-Based Configuration**: Use different configs for sandbox vs production
3. **Implement Automated Testing**: Add tests before deployment
4. **Set up CI/CD Pipeline**: Automate testing and deployment

## Support

For issues, check:
1. Amplify Console build logs
2. CloudWatch logs for Lambda functions
3. Browser console for client-side errors
